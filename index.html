<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ì£¼ë³€ ë§›ì§‘ ì§€ë„</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ½ï¸</text></svg>">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased flex flex-col min-h-screen">
    <div class="container mx-auto p-4 flex flex-col md:flex-row gap-6 items-start">
        <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
        <div class="flex-1 w-full flex flex-col gap-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-center text-gray-900 leading-tight">
                ë‚´ ì£¼ë³€ ë§›ì§‘ ì§€ë„
            </h1>

            <!-- ë©”ì‹œì§€ ë° ë¡œë”© í‘œì‹œ ì˜ì—­ -->
            <div id="message-box" class="text-center text-sm md:text-base text-gray-600">
                ì§€ë„ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
            </div>

            <!-- ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì˜ì—­ -->
            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-8 gap-3" id="category-buttons">
                <button data-category="ì¤‘ì‹" class="category-btn bg-white hover:bg-yellow-50 text-yellow-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">ì¤‘ì‹</button>
                <button data-category="ì°œíƒ•" class="category-btn bg-white hover:bg-red-50 text-red-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">ì°œíƒ•</button>
                <button data-category="í•œì‹" class="category-btn bg-white hover:bg-green-50 text-green-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">í•œì‹</button>
                <button data-category="í”¼ì" class="category-btn bg-white hover:bg-orange-50 text-orange-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">í”¼ì</button>
                <button data-category="ì¹˜í‚¨" class="category-btn bg-white hover:bg-blue-50 text-blue-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">ì¹˜í‚¨</button>
                <button data-category="ë¶„ì‹" class="category-btn bg-white hover:bg-purple-50 text-purple-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">ë¶„ì‹</button>
                <button data-category="ì–‘ê¼¬ì¹˜" class="category-btn bg-white hover:bg-gray-50 text-gray-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">ì–‘ê¼¬ì¹˜</button>
                <button data-category="ë§ˆë¼íƒ•" class="category-btn bg-white hover:bg-pink-50 text-pink-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">ë§ˆë¼íƒ•</button>
            </div>

            <!-- êµ¬ê¸€ ë§µ ì˜ì—­ -->
            <div id="map" class="w-full h-[50vh] md:h-[70vh] rounded-2xl shadow-xl border border-gray-200"></div>

        </div>

        <!-- ì¶”ì²œ ëª©ë¡ ì˜ì—­ -->
        <div class="w-full md:w-1/3 flex flex-col gap-4">
            <h2 class="text-2xl font-bold text-gray-900 text-center md:text-left">ì¶”ì²œ ë§›ì§‘ ëª©ë¡</h2>
            <div id="results-list" class="bg-white rounded-2xl shadow-xl p-4 border border-gray-200 h-[30vh] md:h-[70vh] overflow-y-auto">
                <p class="text-center text-gray-500">
                    ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ë©´<br>ê°€ê¹Œìš´ ë§›ì§‘ì´ í‘œì‹œë©ë‹ˆë‹¤.
                </p>
            </div>
        </div>
    </div>
    <footer class="text-center text-gray-500 text-sm mt-8 mb-4">
        Â© 2024. ì´ ì›¹ì•±ì€ Google Maps APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    </footer>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let map = null;
        let placesService = null;
        let userLocation = null;
        let markers = [];
        let currentCategory = '';
        let isMapInitialized = false;

        // ì „ì—­ ì½œë°± í•¨ìˆ˜ (Google Mapsì—ì„œ í˜¸ì¶œ)
        function initMap() {
            console.log('initMap í•¨ìˆ˜ í˜¸ì¶œë¨');
            
            const defaultLocation = { lat: 37.5665, lng: 126.9780 }; // ì„œìš¸ ì‹œì²­

            try {
                // ì§€ë„ ìƒì„±
                map = new google.maps.Map(document.getElementById("map"), {
                    center: defaultLocation,
                    zoom: 15,
                    disableDefaultUI: true,
                    zoomControl: true
                });

                // PlacesService ìƒì„±
                placesService = new google.maps.places.PlacesService(map);

                console.log('ì§€ë„ì™€ PlacesService ìƒì„± ì™„ë£Œ');

                // ì‚¬ìš©ì ìœ„ì¹˜ ìš”ì²­
                getUserLocation(defaultLocation);

            } catch (error) {
                console.error("ì§€ë„ ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                setMessage("ì§€ë„ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
            }
        }

        // ì‚¬ìš©ì ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
        function getUserLocation(defaultLocation) {
            if (navigator.geolocation) {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 600000 // 10ë¶„
                };

                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        console.log('ì‚¬ìš©ì ìœ„ì¹˜:', userLocation);
                        
                        map.setCenter(userLocation);
                        
                        // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€
                        new google.maps.Marker({
                            position: userLocation,
                            map: map,
                            title: "í˜„ì¬ ìœ„ì¹˜",
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: '#4285F4',
                                fillOpacity: 1,
                                strokeColor: '#ffffff',
                                strokeWeight: 3
                            }
                        });
                        
                        setMessage("ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ë©´ ì£¼ë³€ ë§›ì§‘ì„ ì°¾ì•„ë“œë ¤ìš”.");
                        enableButtons();
                        isMapInitialized = true;
                    },
                    function(error) {
                        console.warn("ìœ„ì¹˜ ì •ë³´ ì˜¤ë¥˜:", error.message);
                        userLocation = defaultLocation;
                        setMessage("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ì„œìš¸ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.");
                        enableButtons();
                        isMapInitialized = true;
                    },
                    options
                );
            } else {
                userLocation = defaultLocation;
                setMessage("ìœ„ì¹˜ ì •ë³´ê°€ ì§€ì›ë˜ì§€ ì•Šì•„ ì„œìš¸ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.");
                enableButtons();
                isMapInitialized = true;
            }
        }

        // UI ì œì–´ í•¨ìˆ˜ë“¤
        function setMessage(text) {
            const messageBox = document.getElementById("message-box");
            if (messageBox) {
                messageBox.textContent = text;
            }
        }

        function enableButtons() {
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(button => {
                button.disabled = false;
            });
        }

        function disableButtons() {
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(button => {
                button.disabled = true;
            });
        }

        function clearMarkers() {
            markers.forEach(marker => {
                if (marker && marker.setMap) {
                    marker.setMap(null);
                }
            });
            markers = [];
        }

        // ê²€ìƒ‰ ê²°ê³¼ ì²˜ë¦¬
        function processSearchResults(results, status) {
            const resultsList = document.getElementById("results-list");
            
            try {
                resultsList.innerHTML = '';
                clearMarkers();

                console.log('ê²€ìƒ‰ ìƒíƒœ:', status);
                console.log('ê²€ìƒ‰ ê²°ê³¼ ìˆ˜:', results ? results.length : 0);

                if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                    // ìœ íš¨í•œ ê²°ê³¼ë§Œ í•„í„°ë§
                    const validResults = results.filter(place => 
                        place && 
                        place.geometry && 
                        place.geometry.location && 
                        place.name &&
                        place.business_status !== 'CLOSED_PERMANENTLY'
                    );

                    const top5Results = validResults.slice(0, 5);
                    
                    if (top5Results.length === 0) {
                        showNoResults();
                        return;
                    }

                    top5Results.forEach((place, index) => {
                        createPlaceItem(place, index);
                    });
                    
                    setMessage(`ì£¼ë³€ ${currentCategory} ë§›ì§‘ ${top5Results.length}ê³³ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!`);
                    
                } else {
                    showErrorResult(status);
                }
            } catch (error) {
                console.error('ê²°ê³¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                showNoResults();
            }
        }

        // ê°œë³„ ì¥ì†Œ ì•„ì´í…œ ìƒì„±
        function createPlaceItem(place, index) {
            const resultsList = document.getElementById("results-list");
            const location = place.geometry.location;
            const name = place.name || "ì´ë¦„ ì—†ìŒ";
            const address = place.vicinity || place.formatted_address || "ì£¼ì†Œ ì •ë³´ ì—†ìŒ";
            const rating = place.rating ? place.rating.toFixed(1) : null;

            // ëª©ë¡ í•­ëª© ìƒì„±
            const listItem = document.createElement("div");
            listItem.className = "flex items-center gap-4 p-3 hover:bg-gray-100 transition-colors duration-200 rounded-lg cursor-pointer";
            
            listItem.innerHTML = `
                <div class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-500 text-white font-bold text-sm shadow">
                    ${index + 1}
                </div>
                <div class="flex-1">
                    <h3 class="font-semibold text-lg text-gray-900">${name}</h3>
                    <p class="text-sm text-gray-500">${address}</p>
                    ${rating ? `<p class="text-sm text-yellow-600">â­ ${rating}</p>` : ''}
                </div>
            `;

            // í´ë¦­ ì´ë²¤íŠ¸
            listItem.addEventListener('click', function() {
                if (map && location) {
                    map.panTo(location);
                    map.setZoom(17);
                }
            });

            resultsList.appendChild(listItem);
            
            if (index < 4) {
                const divider = document.createElement("div");
                divider.className = "h-px bg-gray-200 my-2";
                resultsList.appendChild(divider);
            }
           
            // ì§€ë„ì— ë§ˆì»¤ ì¶”ê°€
            try {
                const marker = new google.maps.Marker({
                    map: map,
                    position: location,
                    title: name
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div class="font-sans p-2 max-w-xs">
                            <h4 class="font-bold text-md mb-1">${name}</h4>
                            <p class="text-sm text-gray-600">${address}</p>
                            ${rating ? `<p class="text-sm text-yellow-600">â­ ${rating}</p>` : ''}
                        </div>
                    `
                });

                marker.addListener("click", function() {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            } catch (error) {
                console.error('ë§ˆì»¤ ìƒì„± ì˜¤ë¥˜:', error);
            }
        }

        // ê²°ê³¼ ì—†ìŒ í‘œì‹œ
        function showNoResults() {
            const resultsList = document.getElementById("results-list");
            resultsList.innerHTML = `<p class="text-center text-gray-500">ì£¼ë³€ì— ${currentCategory} ë§›ì§‘ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.</p>`;
            setMessage(`ì£¼ë³€ì— ${currentCategory} ë§›ì§‘ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        }

        // ì˜¤ë¥˜ ê²°ê³¼ í‘œì‹œ
        function showErrorResult(status) {
            const resultsList = document.getElementById("results-list");
            let errorMessage = "ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            
            if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                errorMessage = `ì£¼ë³€ì— ${currentCategory} ë§›ì§‘ì´ ì—†ìŠµë‹ˆë‹¤.`;
            } else if (status === google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT) {
                errorMessage = "ê²€ìƒ‰ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
            }
            
            resultsList.innerHTML = `<p class="text-center text-gray-500">${errorMessage}</p>`;
            setMessage(errorMessage);
        }

        // ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰
        function searchCategory(category) {
            if (!isMapInitialized || !placesService || !userLocation) {
                setMessage("ì§€ë„ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
                return;
            }

            currentCategory = category;
            setMessage(`'${category}' ë§›ì§‘ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...`);
            
            disableButtons();

            try {
                const request = {
                    location: new google.maps.LatLng(userLocation.lat, userLocation.lng),
                    radius: 1000,
                    type: ['restaurant'],
                    keyword: category
                };

                placesService.nearbySearch(request, function(results, status) {
                    processSearchResults(results, status);
                    enableButtons();
                });

            } catch (error) {
                console.error("ê²€ìƒ‰ ì˜¤ë¥˜:", error);
                setMessage("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                showNoResults();
                enableButtons();
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM ë¡œë“œ ì™„ë£Œ');
            
            // ì´ˆê¸°ì—ëŠ” ë²„íŠ¼ ë¹„í™œì„±í™”
            disableButtons();
            
            // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(function(button) {
                button.addEventListener('click', function() {
                    const category = this.dataset.category;
                    searchCategory(category);
                });
            });
        });

        // ì˜¤ë¥˜ ì²˜ë¦¬
        window.addEventListener('error', function(event) {
            console.error('ì „ì—­ ì˜¤ë¥˜:', event.error);
        });
    </script>

    <!-- Google Maps API -->
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyASe5K_ijvZ6duDsIGWejVX1evTRJZ179Y&libraries=places&callback=initMap"
        onerror="console.error('Google Maps API ë¡œë“œ ì‹¤íŒ¨')"
    ></script>
</body>
</html>
