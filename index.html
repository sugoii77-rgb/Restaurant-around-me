<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>내 주변 맛집 찾기 · v5</title>
  <style>
    :root { --bg:#0b1020; --panel:#121832; --muted:#8ea0c8; --accent:#5aa9ff; --accent2:#7ce7ac; --danger:#ff7a7a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,sans-serif;background:var(--bg);color:#e8eeff}
    header{padding:10px 14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;border-bottom:1px solid rgba(255,255,255,.08);position:sticky;top:0;z-index:3;background:linear-gradient(180deg,rgba(11,16,32,.96),rgba(11,16,32,.86))}
    .title{font-weight:700;margin-right:auto;display:flex;gap:8px;align-items:center}
    .small{color:var(--muted);font-size:12px}
    .wrap{display:grid;grid-template-columns:360px 1fr;height:calc(100vh - 64px)}
    @media (max-width:980px){.wrap{grid-template-columns:1fr;grid-template-rows:48vh 52vh}}
    #map{width:100%;height:100%;background:#0e1328}
    .panel{background:var(--panel);border-left:1px solid rgba(255,255,255,.08);padding:10px;overflow:auto}
    @media (max-width:980px){.panel{border-left:none;border-top:1px solid rgba(255,255,255,.08)}}
    .buttons{display:grid;grid-auto-flow:column;grid-auto-columns:max-content;gap:6px;overflow-x:auto;padding-bottom:6px}
    .btn{border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.04);color:#eaf1ff;padding:8px 10px;border-radius:999px;font-size:14px;cursor:pointer;white-space:nowrap}
    .btn:hover{background:rgba(255,255,255,.08)}
    .btn.active{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#0b1020;font-weight:700}
    .status{color:var(--muted);font-size:13px}
    .loc{color:var(--muted);font-size:12px}
    .list{display:grid;gap:10px;padding:8px 2px}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;display:grid;gap:6px}
    .name{font-weight:700}
    .meta{color:var(--muted);font-size:13px;display:flex;gap:10px;flex-wrap:wrap}
    .rank{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:6px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);font-weight:700;margin-right:6px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:rgba(255,255,255,.06);padding:2px 6px;border-radius:6px;border:1px solid rgba(255,255,255,.12)}
    .danger{color:var(--danger)}
  </style>
</head>
<body>
  <header>
    <div class="title">🍜 내 주변 맛집 찾기 <span id="activeLabel" class="small">카테고리 선택</span></div>
    <div class="buttons" id="buttons"></div>
    <div class="status" id="status">초기화 중...</div>
  </header>

  <div class="wrap">
    <aside class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px">
        <div class="loc" id="locText">현재 위치: 파악 중</div>
        <button id="recenterBtn" class="btn">현재 위치 재설정</button>
      </div>
      <div class="small">버튼을 누르면 현재 위치 기준으로 가까운 5곳을 거리순으로 보여줍니다. (Places API New)</div>
      <div class="list" id="list"></div>
      <div class="small" style="padding-top:6px">Tip: 위치 권한은 <span class="kbd">https</span> 또는 <span class="kbd">localhost</span> 에서만 정상 동작.</div>
    </aside>
    <main id="map"></main>
  </div>

  <script>
    // ===== 설정 =====
    const API_KEY = 'AIzaSyASe5K_ijvZ6duDsIGWejVX1evTRJZ179Y'; // referrer 제한 필수
    const MAP_ID = 'YOUR_VECTOR_MAP_ID'; // ▶ Console > Maps > Map Management > Create Map ID 후 교체
    const ADVANCED_OK = MAP_ID && !MAP_ID.includes('YOUR_VECTOR_MAP_ID');

    // 카테고리 전략: 타입 기반(nearby) vs 키워드 기반(text)
    const STRATEGY = {
      '중식':  { mode: 'nearby', includedTypes: ['chinese_restaurant'], fallbackQuery: '중식 중국집 Chinese restaurant' },
      '한식':  { mode: 'nearby', includedTypes: ['korean_restaurant'],  fallbackQuery: '한식 Korean restaurant' },
      '피자':  { mode: 'nearby', includedTypes: ['pizza_restaurant'],   fallbackQuery: '피자 pizza' },
      '치킨':  { mode: 'text',   textQuery: '치킨 fried chicken' },
      '분식':  { mode: 'text',   textQuery: '분식 떡볶이 순대 튀김 tteokbokki snack bar' },
      '찜탕':  { mode: 'text',   textQuery: '찜 탕 감자탕 해물찜 갈비찜 곰탕 soup stew' },
      '양꼬치': { mode: 'text',   textQuery: '양꼬치 양갈비 lamb skewers yangkkochi chuan' },
      '마라탕': { mode: 'text',   textQuery: '마라탕 마라샹궈 malatang hot pot' }
    };
    const CATEGORY_ORDER = ['중식','찜탕','한식','피자','치킨','분식','양꼬치','마라탕'];

    let map, userLatLng, infoWindow, AdvancedMarkerElement, LegacyMarker;
    const resultRefs = []; // { remove() }

    function setStatus(msg, isError=false){ const el=document.getElementById('status'); el.textContent=msg; el.className=isError?'status danger':'status'; }
    function setLocText(t){ document.getElementById('locText').textContent=`현재 위치: ${t}`; }
    function metersToText(m){ if(!Number.isFinite(m)) return ''; return m<1000?`${Math.round(m)} m`:`${(m/1000).toFixed(2)} km`; }
    function clearResultMarkers(){ while(resultRefs.length){ const r=resultRefs.pop(); try{ r.remove(); }catch{} } }
    function haversine(a,b){ const R=6371000,toRad=x=>x*Math.PI/180; const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng); const s1=Math.sin(dLat/2)**2, s2=Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(s1+s2)); }

    function renderButtons(){
      const box=document.getElementById('buttons');
      CATEGORY_ORDER.forEach(cat=>{
        const b=document.createElement('button'); b.className='btn'; b.textContent=cat; b.dataset.cat=cat;
        b.addEventListener('click',()=>{ if(!userLatLng) return setStatus('위치 확인 후 사용하세요.', true); document.getElementById('activeLabel').textContent=`선택: ${cat}`; findPlaces(cat); });
        box.appendChild(b);
      });
    }

    async function initMap(){
      setStatus('지도 로딩 중...');
      const { Map } = await google.maps.importLibrary('maps');
      const markerLib = await google.maps.importLibrary('marker');
      AdvancedMarkerElement = markerLib.AdvancedMarkerElement; // 새 마커
      LegacyMarker = google.maps.Marker; // 폴백 마커
      infoWindow = new google.maps.InfoWindow();

      const defaultCenter = { lat: 37.5665, lng: 126.9780 };
      const mapOptions = { center: defaultCenter, zoom: 14, streetViewControl:false, mapTypeControl:false, fullscreenControl:true, backgroundColor:'#0e1328' };
      if (ADVANCED_OK) mapOptions.mapId = MAP_ID;
      map = new Map(document.getElementById('map'), mapOptions);

      if('geolocation' in navigator){
        navigator.geolocation.getCurrentPosition(pos=>{
          const { latitude, longitude } = pos.coords; userLatLng = { lat: latitude, lng: longitude };
          map.setCenter(userLatLng); map.setZoom(15);
          addSelfMarker(userLatLng);
          setStatus('위치 확인됨. 카테고리를 선택하세요.');
          setLocText(`${latitude.toFixed(5)}, ${longitude.toFixed(5)}`);
        }, err=>{ console.warn(err); setStatus('위치 권한이 거부되어 기본 위치로 표시 중입니다.', true); setLocText('권한 거부됨'); addSelfMarker(defaultCenter); }, { timeout: 10000, maximumAge: 60000 });
      } else { setStatus('이 브라우저는 위치 정보를 지원하지 않습니다.', true); setLocText('미지원'); addSelfMarker(defaultCenter); }

      document.getElementById('recenterBtn').addEventListener('click',()=>{ if(!userLatLng) return setStatus('위치 정보 없음. 위치 권한을 허용하세요.', true); map.panTo(userLatLng); map.setZoom(15); });
      renderButtons();
    }

    function addSelfMarker(position){
      if (ADVANCED_OK && AdvancedMarkerElement){
        const el=document.createElement('div'); el.style.cssText='width:14px;height:14px;border-radius:50%;background:#7ce7ac;border:2px solid #173a2a';
        const m = new AdvancedMarkerElement({ map, position, content: el, title:'내 위치' });
        resultRefs.push({ remove: ()=> m.map = null });
      } else {
        const m = new LegacyMarker({ map, position, title:'내 위치' });
        resultRefs.push({ remove: ()=> m.setMap(null) });
        // 고급 마커 경고 회피하려면 MAP_ID 발급 후 위 ADVANCED_OK를 true로
        console.warn('AdvancedMarkerElement 폴백: mapId가 없거나 벡터 맵 미사용');
      }
    }

    async function findPlaces(category){
      clearResultMarkers(); document.getElementById('list').innerHTML=''; setStatus(`${category} 검색 중...`);
      const cfg = STRATEGY[category] || { mode:'nearby', includedTypes:['restaurant'], fallbackQuery:'restaurant' };

      try {
        let places = [];
        if (cfg.mode === 'nearby') {
          places = await nearbySearch(cfg.includedTypes);
          if (places.length === 0 && cfg.fallbackQuery) {
            console.warn('nearby 결과 없음, textSearch로 폴백');
            places = await textSearch(cfg.fallbackQuery);
          }
        } else {
          places = await textSearch(cfg.textQuery);
        }

        if (places.length === 0) { setStatus('검색 결과가 없습니다.', true); return; }

        const withDist = places.map(p=>{ const loc={ lat:p.location.latitude, lng:p.location.longitude }; return { place:p, loc, distance: haversine(userLatLng, loc) }; }).sort((a,b)=>a.distance-b.distance).slice(0,5);
        withDist.forEach((it,idx)=> addResultMarker(it, idx));
        renderList(withDist); setStatus(`${category} 결과 ${withDist.length}개`);
      } catch (e) {
        console.error(e); setStatus('검색 실패. 콘솔 로그를 확인하세요.', true);
      }
    }

    async function nearbySearch(includedTypes){
      const body = {
        includedTypes,
        rankPreference: 'DISTANCE',
        languageCode: 'ko',
        locationRestriction: { circle: { center: { latitude: userLatLng.lat, longitude: userLatLng.lng }, radius: 5000 } }
      };
      const resp = await fetch('https://places.googleapis.com/v1/places:searchNearby',{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'X-Goog-Api-Key': API_KEY,
          'X-Goog-FieldMask':'places.id,places.displayName,places.formattedAddress,places.location,places.rating,places.userRatingCount,places.currentOpeningHours.openNow'
        },
        body: JSON.stringify(body)
      });
      if (!resp.ok) { const t=await resp.text(); console.error('Nearby error', resp.status, t); return []; }
      const data = await resp.json();
      return Array.isArray(data.places) ? data.places : [];
    }

    async function textSearch(query){
      const body = {
        textQuery: query,
        languageCode: 'ko',
        locationBias: { circle: { center: { latitude: userLatLng.lat, longitude: userLatLng.lng }, radius: 5000 } }
      };
      const resp = await fetch('https://places.googleapis.com/v1/places:searchText',{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'X-Goog-Api-Key': API_KEY,
          'X-Goog-FieldMask':'places.id,places.displayName,places.formattedAddress,places.location,places.rating,places.userRatingCount,places.currentOpeningHours.openNow'
        },
        body: JSON.stringify(body)
      });
      if (!resp.ok) { const t=await resp.text(); console.error('TextSearch error', resp.status, t); return []; }
      const data = await resp.json();
      return Array.isArray(data.places) ? data.places : [];
    }

    function addResultMarker(item, idx){
      const { place, loc, distance } = item;
      const name = place.displayName?.text || '';
      if (ADVANCED_OK && AdvancedMarkerElement){
        const el=document.createElement('div'); el.style.cssText='width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:#5aa9ff;border:2px solid #072847;color:#0b1020;font-weight:700'; el.textContent=String(idx+1);
        const m = new AdvancedMarkerElement({ map, position: loc, content: el, title: name });
        m.addListener('click',()=> openInfo(m, place, distance));
        resultRefs.push({ remove: ()=> m.map = null });
      } else {
        const m = new LegacyMarker({ map, position: loc, label: String(idx+1), title: name });
        m.addListener('click',()=> openInfo(m, place, distance));
        resultRefs.push({ remove: ()=> m.setMap(null) });
      }
      if(idx===0) map.panTo(loc);
    }

    function openInfo(marker, place, distance){
      if(!infoWindow) infoWindow = new google.maps.InfoWindow();
      const name = place.displayName?.text || '이름 없음';
      const addr = place.formattedAddress || '';
      const rating = place.rating ? `⭐️ ${Number(place.rating).toFixed(1)} (${place.userRatingCount||0})` : '평점 정보 없음';
      const openNow = place.currentOpeningHours?.openNow===true ? '영업 중' : (place.currentOpeningHours?.openNow===false ? '영업 종료' : '');
      const html = `<div style="min-width:220px;max-width:280px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,sans-serif"><div style="font-weight:700;font-size:14px;margin-bottom:4px">${name}</div><div style="font-size:12px;color:#55648d;margin-bottom:4px">${addr}</div><div style="font-size:12px;color:#55648d;display:flex;gap:8px;flex-wrap:wrap"><span>${rating}</span><span>📍 ${metersToText(distance)}</span>${openNow?`<span>${openNow}</span>`:''}</div></div>`;
      infoWindow.setContent(html); infoWindow.open({ map, anchor: marker });
    }

    function renderList(items){
      const list=document.getElementById('list');
      list.innerHTML='';
      items.forEach((item, idx)=>{
        const { place, distance } = item; const card=document.createElement('div'); card.className='card';
        const name=document.createElement('div'); name.className='name'; name.innerHTML = `<span class="rank">${idx+1}</span> ${place.displayName?.text || ''}`;
        const meta=document.createElement('div'); meta.className='meta';
        const rating = place.rating ? `⭐️ ${Number(place.rating).toFixed(1)} (${place.userRatingCount||0})` : '평점 정보 없음';
        const addr = place.formattedAddress || '';
        meta.innerHTML = `<span>📍 ${metersToText(distance)}</span><span>${rating}</span><span>${addr}</span>`;
        card.appendChild(name); card.appendChild(meta);
        card.addEventListener('click',()=>{ /* 선택 시 마커로 이동하려면 여기에서 참조를 보관해서 이동 가능 */ });
        list.appendChild(card);
      });
    }

    window.initMap = initMap;
  </script>
  <!-- async + callback 로더 -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyASe5K_ijvZ6duDsIGWejVX1evTRJZ179Y&loading=async&v=weekly&language=ko&region=KR&callback=initMap" async defer></script>
</body>
</html>
