<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>내 주변 맛집 지도</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tailwind CSS 설정 */
        :root {
            --inter-font: 'Inter', sans-serif;
        }

        body {
            font-family: var(--inter-font);
        }
        
        /* 커스텀 스크롤바 스타일 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased flex flex-col min-h-screen">
    <div class="container mx-auto p-4 flex flex-col md:flex-row gap-6 items-start">
        <!-- 메인 컨텐츠 영역 -->
        <div class="flex-1 w-full flex flex-col gap-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-center text-gray-900 leading-tight">
                내 주변 맛집 지도
            </h1>

            <!-- 메시지 및 로딩 표시 영역 -->
            <div id="message-box" class="text-center text-sm md:text-base text-gray-600">
                지도에서 현재 위치를 확인하고, 아래 버튼을 눌러보세요!
            </div>

            <!-- 카테고리 버튼 영역 -->
            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-8 gap-3">
                <button data-category="중식" class="category-btn bg-white hover:bg-yellow-50 text-yellow-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200">중식</button>
                <button data-category="찜탕" class="category-btn bg-white hover:bg-red-50 text-red-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200">찜탕</button>
                <button data-category="한식" class="category-btn bg-white hover:bg-green-50 text-green-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200">한식</button>
                <button data-category="피자" class="category-btn bg-white hover:bg-orange-50 text-orange-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200">피자</button>
                <button data-category="치킨" class="category-btn bg-white hover:bg-blue-50 text-blue-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200">치킨</button>
                <button data-category="분식" class="category-btn bg-white hover:bg-purple-50 text-purple-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200">분식</button>
                <button data-category="양꼬치" class="category-btn bg-white hover:bg-gray-50 text-gray-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200">양꼬치</button>
                <button data-category="마라탕" class="category-btn bg-white hover:bg-pink-50 text-pink-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200">마라탕</button>
            </div>

            <!-- 구글 맵 영역 -->
            <div id="map" class="w-full h-[50vh] md:h-[70vh] rounded-2xl shadow-xl border border-gray-200"></div>

        </div>

        <!-- 추천 목록 영역 -->
        <div class="w-full md:w-1/3 flex flex-col gap-4">
            <h2 class="text-2xl font-bold text-gray-900 text-center md:text-left">추천 맛집 목록</h2>
            <div id="results-list" class="bg-white rounded-2xl shadow-xl p-4 border border-gray-200 h-[30vh] md:h-[70vh] overflow-y-auto">
                <p class="text-center text-gray-500">
                    카테고리를 선택하면<br>가까운 맛집이 표시됩니다.
                </p>
            </div>
        </div>
    </div>
    <footer class="text-center text-gray-500 text-sm mt-8 mb-4">
        © 2024. 이 웹앱은 Google Maps API를 사용합니다.
    </footer>

    <!-- Google Maps API 스크립트 -->
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyASe5K_ijvZ6duDsIGWejVX1evTRJZ179Y&callback=initMap&libraries=places,marker&v=weekly"
        defer
    ></script>

    <script>
        // Google Maps API 키를 AIzaSyASe5K_ijvZ6duDsIGWejVX1evTRJZ179Y 부분에 넣어주세요.
        // Google Cloud Console에서 Places API와 Maps JavaScript API가 활성화되어 있는지 확인하세요.

        let map;
        let userLocation;
        let markers = [];
        let currentCategory = '';

        /**
         * 지도와 API를 초기화하는 함수.
         * Google Maps API가 로드되면 자동으로 호출됩니다.
         */
        async function initMap() {
            const { Map } = await google.maps.importLibrary("maps");
            const { Place } = await google.maps.importLibrary("places");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            
            const defaultLocation = { lat: 37.5665, lng: 126.9780 }; // 서울 시청

            // 사용자 위치를 가져오는 비동기 함수
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        createMap(Map, AdvancedMarkerElement, userLocation);
                        setMessage("카테고리를 선택하면 주변 맛집을 찾아드려요.");
                    },
                    (error) => {
                        console.error("Geolocation Error:", error);
                        setMessage("위치 정보를 가져올 수 없습니다. 서울 중심으로 지도를 표시합니다.");
                        createMap(Map, AdvancedMarkerElement, defaultLocation);
                    }
                );
            } else {
                setMessage("이 브라우저에서는 위치 정보가 지원되지 않습니다. 서울 중심으로 지도를 표시합니다.");
                createMap(Map, AdvancedMarkerElement, defaultLocation);
            }
        }

        /**
         * 지도 객체를 생성하고 초기화하는 함수.
         * @param {Object} Map - google.maps.Map 클래스.
         * @param {Object} AdvancedMarkerElement - google.maps.marker.AdvancedMarkerElement 클래스.
         * @param {Object} center - 지도의 중심 좌표. {lat, lng} 형식.
         */
        function createMap(Map, AdvancedMarkerElement, center) {
            map = new Map(document.getElementById("map"), {
                center: center,
                zoom: 15,
                disableDefaultUI: true,
                zoomControl: true,
            });

            // 사용자 위치에 마커 추가
            const userMarker = new AdvancedMarkerElement({
                position: center,
                map,
                title: "현재 위치",
            });
        }

        /**
         * 주어진 메시지를 UI에 표시하는 함수.
         * @param {string} text - 표시할 메시지 텍스트.
         */
        function setMessage(text) {
            const messageBox = document.getElementById("message-box");
            if (messageBox) {
                messageBox.textContent = text;
            }
        }

        /**
         * 지도에 있는 모든 마커를 제거하는 함수.
         */
        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }

        /**
         * 검색 결과를 지도에 마커로 표시하고 목록을 생성하는 함수.
         * @param {Array} places - Places API 검색 결과.
         */
        async function processResults(places) {
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            const resultsList = document.getElementById("results-list");
            resultsList.innerHTML = ''; // 기존 목록 초기화
            clearMarkers();

            if (places && places.length > 0) {
                const top5Results = places.slice(0, 5); // 상위 5개만 사용
                
                top5Results.forEach((place, index) => {
                    const placeLocation = place.location;

                    // 목록 항목 생성
                    const listItem = document.createElement("div");
                    listItem.className = "flex items-center gap-4 p-3 hover:bg-gray-100 transition-colors duration-200 rounded-lg cursor-pointer";
                    listItem.innerHTML = `
                        <div class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-500 text-white font-bold text-sm shadow">
                            ${index + 1}
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg text-gray-900">${place.displayName.text}</h3>
                            <p class="text-sm text-gray-500">${place.formattedAddress}</p>
                        </div>
                    `;

                    // 목록 항목 클릭 시 지도 이동 및 마커에 정보창 열기
                    listItem.addEventListener('click', () => {
                        map.panTo(placeLocation);
                        // TODO: New Infowindow functionality for Advanced Markers
                    });

                    resultsList.appendChild(listItem);
                    if (index < top5Results.length - 1) {
                         const divider = document.createElement("div");
                         divider.className = "h-px bg-gray-200 my-2";
                         resultsList.appendChild(divider);
                    }
                   
                    // 지도에 마커 추가
                    const marker = new AdvancedMarkerElement({
                        map,
                        position: placeLocation,
                        title: place.displayName.text,
                    });
                    markers.push(marker);

                    const infowindow = new google.maps.InfoWindow({
                        content: `
                            <div class="font-sans p-1">
                                <h4 class="font-bold text-md mb-1">${place.displayName.text}</h4>
                                <p class="text-sm text-gray-600">${place.formattedAddress}</p>
                            </div>
                        `
                    });

                    // 마커 클릭 시 정보창 열기
                    marker.addListener("click", () => {
                        infowindow.open({
                            anchor: marker,
                            map,
                            shouldFocus: false,
                        });
                    });
                });
                setMessage(`주변 ${currentCategory} 맛집 5곳을 찾았습니다!`);
                map.setZoom(15);
            } else {
                resultsList.innerHTML = `<p class="text-center text-gray-500">주변에 ${currentCategory} 맛집을 찾을 수 없습니다.</p>`;
                setMessage(`주변 ${currentCategory} 맛집을 찾을 수 없습니다.`);
            }
        }

        /**
         * 카테고리 버튼 클릭 이벤트 핸들러.
         * @param {Event} event - 클릭 이벤트 객체.
         */
        async function handleCategoryClick(event) {
            if (!userLocation) {
                setMessage("위치 정보를 가져오는 중입니다. 잠시만 기다려주세요.");
                return;
            }

            const { Place, SearchNearbyRankPreference } = await google.maps.importLibrary("places");
            const category = event.target.dataset.category;
            currentCategory = category;
            setMessage(`'${category}' 맛집을 찾고 있습니다...`);
            
            // 새로운 Places API를 이용한 주변 검색 요청
            try {
                const request = {
                    locationRestriction: {
                        center: userLocation,
                        radius: 1000.0,
                    },
                    includedType: 'restaurant',
                    includedPrimaryTypes: ['restaurant'],
                    rankPreference: SearchNearbyRankPreference.DISTANCE,
                    keyword: category,
                };

                const { places } = await Place.searchNearby(request);
                processResults(places);

            } catch (error) {
                setMessage("검색 결과를 불러오는 데 실패했습니다. 콘솔을 확인해주세요.");
                console.error("Places API Error:", error);
            }
        }

        // 모든 카테고리 버튼에 이벤트 리스너 추가
        document.addEventListener('DOMContentLoaded', () => {
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(button => {
                button.addEventListener('click', handleCategoryClick);
            });
        });
    </script>
</body>
</html>
