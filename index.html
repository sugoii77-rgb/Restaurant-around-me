<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>내 주변 맛집 지도</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🍽️</text></svg>">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tailwind CSS 설정 */
        :root {
            --inter-font: 'Inter', sans-serif;
        }

        body {
            font-family: var(--inter-font);
        }
        
        /* 커스텀 스크롤바 스타일 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased flex flex-col min-h-screen">
    <div class="container mx-auto p-4 flex flex-col md:flex-row gap-6 items-start">
        <!-- 메인 컨텐츠 영역 -->
        <div class="flex-1 w-full flex flex-col gap-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-center text-gray-900 leading-tight">
                내 주변 맛집 지도
            </h1>

            <!-- 메시지 및 로딩 표시 영역 -->
            <div id="message-box" class="text-center text-sm md:text-base text-gray-600">
                지도를 로딩 중입니다...
            </div>

            <!-- 카테고리 버튼 영역 -->
            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-8 gap-3" id="category-buttons">
                <button data-category="중식" class="category-btn bg-white hover:bg-yellow-50 text-yellow-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">중식</button>
                <button data-category="찜탕" class="category-btn bg-white hover:bg-red-50 text-red-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">찜탕</button>
                <button data-category="한식" class="category-btn bg-white hover:bg-green-50 text-green-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">한식</button>
                <button data-category="피자" class="category-btn bg-white hover:bg-orange-50 text-orange-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">피자</button>
                <button data-category="치킨" class="category-btn bg-white hover:bg-blue-50 text-blue-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">치킨</button>
                <button data-category="분식" class="category-btn bg-white hover:bg-purple-50 text-purple-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">분식</button>
                <button data-category="양꼬치" class="category-btn bg-white hover:bg-gray-50 text-gray-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">양꼬치</button>
                <button data-category="마라탕" class="category-btn bg-white hover:bg-pink-50 text-pink-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">마라탕</button>
            </div>

            <!-- 구글 맵 영역 -->
            <div id="map" class="w-full h-[50vh] md:h-[70vh] rounded-2xl shadow-xl border border-gray-200"></div>

        </div>

        <!-- 추천 목록 영역 -->
        <div class="w-full md:w-1/3 flex flex-col gap-4">
            <h2 class="text-2xl font-bold text-gray-900 text-center md:text-left">추천 맛집 목록</h2>
            <div id="results-list" class="bg-white rounded-2xl shadow-xl p-4 border border-gray-200 h-[30vh] md:h-[70vh] overflow-y-auto">
                <p class="text-center text-gray-500">
                    카테고리를 선택하면<br>가까운 맛집이 표시됩니다.
                </p>
            </div>
        </div>
    </div>
    <footer class="text-center text-gray-500 text-sm mt-8 mb-4">
        © 2024. 이 웹앱은 Google Maps API를 사용합니다.
    </footer>

    <!-- Google Maps API 스크립트 -->
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyASe5K_ijvZ6duDsIGWejVX1evTRJZ179Y&libraries=places&callback=initMap&loading=async"
        defer
    ></script>

    <script>
        let map;
        let placesService;
        let userLocation;
        let markers = [];
        let currentCategory = '';
        let isMapReady = false;

        // 전역 콜백 함수
        window.initMap = function() {
            initializeMap();
        };

        // 지도 초기화 함수
        function initializeMap() {
            const defaultLocation = { lat: 37.5665, lng: 126.9780 }; // 서울 시청

            try {
                // 지도 생성
                map = new google.maps.Map(document.getElementById("map"), {
                    center: defaultLocation,
                    zoom: 15,
                    disableDefaultUI: true,
                    zoomControl: true,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false
                });

                // PlacesService 생성 (여전히 nearbySearch는 작동함)
                placesService = new google.maps.places.PlacesService(map);

                // 사용자 위치 가져오기
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            map.setCenter(userLocation);
                            
                            // 사용자 위치 마커 추가
                            new google.maps.Marker({
                                position: userLocation,
                                map: map,
                                title: "현재 위치",
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 10,
                                    fillColor: '#4285F4',
                                    fillOpacity: 1,
                                    strokeColor: '#ffffff',
                                    strokeWeight: 3
                                }
                            });
                            
                            setMessage("카테고리를 선택하면 주변 맛집을 찾아드려요.");
                            enableButtons();
                        },
                        (error) => {
                            console.warn("위치 정보 접근 실패:", error.message);
                            userLocation = defaultLocation;
                            setMessage("위치 정보를 가져올 수 없어 서울 중심으로 설정했습니다. 카테고리를 선택해보세요.");
                            enableButtons();
                        }
                    );
                } else {
                    userLocation = defaultLocation;
                    setMessage("위치 정보가 지원되지 않아 서울 중심으로 설정했습니다. 카테고리를 선택해보세요.");
                    enableButtons();
                }

                isMapReady = true;
                console.log("지도 초기화 완료");
                
            } catch (error) {
                console.error("지도 초기화 오류:", error);
                setMessage("지도 초기화에 실패했습니다. 페이지를 새로고침해주세요.");
            }
        }

        // 버튼 활성화/비활성화
        function enableButtons() {
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(button => {
                button.disabled = false;
            });
        }

        function disableButtons() {
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(button => {
                button.disabled = true;
            });
        }

        // 메시지 설정
        function setMessage(text) {
            const messageBox = document.getElementById("message-box");
            if (messageBox) {
                messageBox.textContent = text;
            }
        }

        // 마커 제거
        function clearMarkers() {
            markers.forEach(marker => {
                marker.setMap(null);
            });
            markers = [];
        }

        // 검색 결과 처리 함수
        function handleSearchResults(results, status) {
            const resultsList = document.getElementById("results-list");
            resultsList.innerHTML = '';
            clearMarkers();

            console.log('검색 상태:', status);
            console.log('검색 결과:', results);

            if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                const filteredResults = results.filter(place => 
                    place.geometry && 
                    place.geometry.location && 
                    place.name &&
                    place.business_status !== 'CLOSED_PERMANENTLY'
                );

                const top5Results = filteredResults.slice(0, 5);
                
                if (top5Results.length === 0) {
                    resultsList.innerHTML = `<p class="text-center text-gray-500">주변에 영업 중인 ${currentCategory} 맛집을 찾을 수 없습니다.<br>다른 카테고리를 시도해보세요.</p>`;
                    setMessage(`주변에 영업 중인 ${currentCategory} 맛집을 찾을 수 없습니다.`);
                    return;
                }

                top5Results.forEach((place, index) => {
                    const location = place.geometry.location;
                    const name = place.name || "이름 없음";
                    const address = place.vicinity || place.formatted_address || "주소 정보 없음";
                    const rating = place.rating ? `⭐ ${place.rating.toFixed(1)}` : "";
                    const isOpen = place.opening_hours?.open_now;
                    
                    // 목록 항목 생성
                    const listItem = document.createElement("div");
                    listItem.className = "flex items-center gap-4 p-3 hover:bg-gray-100 transition-colors duration-200 rounded-lg cursor-pointer";
                    
                    listItem.innerHTML = `
                        <div class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-500 text-white font-bold text-sm shadow">
                            ${index + 1}
                        </div>
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg text-gray-900">${name}</h3>
                            <p class="text-sm text-gray-500">${address}</p>
                            <div class="flex items-center gap-2 mt-1">
                                ${rating ? `<span class="text-sm text-yellow-600">${rating}</span>` : ''}
                                ${isOpen !== undefined ? `<span class="text-xs px-2 py-1 rounded ${isOpen ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${isOpen ? '영업중' : '영업종료'}</span>` : ''}
                            </div>
                        </div>
                    `;

                    // 클릭 이벤트
                    listItem.addEventListener('click', () => {
                        map.panTo(location);
                        map.setZoom(17);
                        
                        // 모든 InfoWindow 닫기
                        markers.forEach(m => {
                            if (m.infoWindow) {
                                m.infoWindow.close();
                            }
                        });
                        
                        // 해당 마커의 InfoWindow 열기
                        const marker = markers[index];
                        if (marker && marker.infoWindow) {
                            marker.infoWindow.open(map, marker);
                        }
                    });

                    resultsList.appendChild(listItem);
                    
                    if (index < top5Results.length - 1) {
                        const divider = document.createElement("div");
                        divider.className = "h-px bg-gray-200 my-2";
                        resultsList.appendChild(divider);
                    }
                   
                    // 지도에 마커 추가
                    const marker = new google.maps.Marker({
                        map: map,
                        position: location,
                        title: name,
                        animation: google.maps.Animation.DROP
                    });

                    // 정보창 생성
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div class="font-sans p-2 max-w-xs">
                                <h4 class="font-bold text-md mb-1">${name}</h4>
                                <p class="text-sm text-gray-600 mb-1">${address}</p>
                                <div class="flex items-center gap-2">
                                    ${rating ? `<span class="text-sm text-yellow-600">${rating}</span>` : ''}
                                    ${isOpen !== undefined ? `<span class="text-xs px-2 py-1 rounded ${isOpen ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${isOpen ? '영업중' : '영업종료'}</span>` : ''}
                                </div>
                            </div>
                        `
                    });

                    // 마커에 InfoWindow 연결
                    marker.infoWindow = infoWindow;

                    // 마커 클릭 이벤트
                    marker.addListener("click", () => {
                        // 모든 InfoWindow 닫기
                        markers.forEach(m => {
                            if (m.infoWindow) {
                                m.infoWindow.close();
                            }
                        });
                        infoWindow.open(map, marker);
                    });

                    markers.push(marker);
                });
                
                setMessage(`주변 ${currentCategory} 맛집 ${top5Results.length}곳을 찾았습니다!`);
                
            } else {
                let errorMessage;
                
                if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                    errorMessage = `주변 1km 내에 ${currentCategory} 맛집이 없습니다.`;
                } else if (status === google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT) {
                    errorMessage = "검색 한도를 초과했습니다. 잠시 후 다시 시도해주세요.";
                } else if (status === google.maps.places.PlacesServiceStatus.REQUEST_DENIED) {
                    errorMessage = "검색 요청이 거부되었습니다. API 키를 확인해주세요.";
                } else {
                    errorMessage = `검색 중 오류가 발생했습니다. (${status})`;
                }
                
                resultsList.innerHTML = `<p class="text-center text-gray-500">${errorMessage}<br>다른 카테고리를 시도해보세요.</p>`;
                setMessage(errorMessage);
            }
        }

        // 카테고리 버튼 클릭 핸들러
        function handleCategoryClick(event) {
            if (!isMapReady || !placesService || !userLocation) {
                setMessage("지도가 아직 준비되지 않았습니다. 잠시만 기다려주세요.");
                return;
            }

            const category = event.target.dataset.category;
            currentCategory = category;
            setMessage(`'${category}' 맛집을 찾고 있습니다...`);
            
            disableButtons();
            
            try {
                // nearbySearch 요청
                const request = {
                    location: new google.maps.LatLng(userLocation.lat, userLocation.lng),
                    radius: 1000, // 1km 반경
                    type: ['restaurant'],
                    keyword: `${category} 맛집`
                };

                console.log('검색 요청:', request);
                placesService.nearbySearch(request, (results, status) => {
                    handleSearchResults(results, status);
                    enableButtons();
                });
                
            } catch (error) {
                console.error("검색 요청 오류:", error);
                setMessage("검색 중 오류가 발생했습니다. 다시 시도해주세요.");
                
                const resultsList = document.getElementById("results-list");
                resultsList.innerHTML = `<p class="text-center text-gray-500">검색 중 오류가 발생했습니다.<br>잠시 후 다시 시도해주세요.</p>`;
                
                enableButtons();
            }
        }

        // 이벤트 리스너 설정
        document.addEventListener('DOMContentLoaded', () => {
            // 초기에는 버튼 비활성화
            disableButtons();
            
            // 카테고리 버튼들
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(button => {
                button.addEventListener('click', handleCategoryClick);
            });
        });
    </script>
</body>
</html>
