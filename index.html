<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ì£¼ë³€ ë§›ì§‘ ì§€ë„</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ½ï¸</text></svg>">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased flex flex-col min-h-screen">
    <div class="container mx-auto p-4 flex flex-col md:flex-row gap-6 items-start">
        <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
        <div class="flex-1 w-full flex flex-col gap-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-center text-gray-900 leading-tight">
                ë‚´ ì£¼ë³€ ë§›ì§‘ ì§€ë„
            </h1>

            <!-- API í‚¤ ì…ë ¥ ì˜ì—­ -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="font-semibold text-blue-800 mb-2">ğŸ”‘ Google Maps API í‚¤ ì„¤ì •</h3>
                <p class="text-sm text-blue-700 mb-3">
                    í˜„ì¬ API í‚¤ì— ë¬¸ì œê°€ ìˆëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                    <br><a href="https://console.cloud.google.com/google/maps-apis/credentials" target="_blank" class="underline font-semibold">Google Cloud Console</a>ì—ì„œ API í‚¤ë¥¼ ë°œê¸‰ë°›ìœ¼ì„¸ìš”.
                </p>
                <div class="flex gap-2 mb-2">
                    <input 
                        type="text" 
                        id="api-key-input" 
                        placeholder="ìƒˆë¡œìš´ Google Maps API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm"
                        value="AIzaSyASe5K_ijvZ6duDsIGWejVX1evTRJZ179Y"
                    >
                    <button 
                        id="load-map-btn" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700 transition-colors"
                    >
                        ì§€ë„ ë‹¤ì‹œ ë¡œë“œ
                    </button>
                </div>
                <div class="text-xs text-blue-600">
                    âœ… Maps JavaScript APIì™€ Places APIê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”<br>
                    âœ… API í‚¤ì— ê²°ì œ ê³„ì •ì´ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”
                </div>
            </div>

            <!-- ë©”ì‹œì§€ ë° ë¡œë”© í‘œì‹œ ì˜ì—­ -->
            <div id="message-box" class="text-center text-sm md:text-base text-gray-600">
                ìœ„ì—ì„œ ìœ íš¨í•œ API í‚¤ë¥¼ ì…ë ¥í•˜ê³  "ì§€ë„ ë‹¤ì‹œ ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”.
            </div>

            <!-- ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì˜ì—­ -->
            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-8 gap-3" id="category-buttons" style="display: none;">
                <button data-category="ì¤‘ì‹" class="category-btn bg-white hover:bg-yellow-50 text-yellow-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">ì¤‘ì‹</button>
                <button data-category="ì°œíƒ•" class="category-btn bg-white hover:bg-red-50 text-red-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">ì°œíƒ•</button>
                <button data-category="í•œì‹" class="category-btn bg-white hover:bg-green-50 text-green-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">í•œì‹</button>
                <button data-category="í”¼ì" class="category-btn bg-white hover:bg-orange-50 text-orange-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">í”¼ì</button>
                <button data-category="ì¹˜í‚¨" class="category-btn bg-white hover:bg-blue-50 text-blue-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">ì¹˜í‚¨</button>
                <button data-category="ë¶„ì‹" class="category-btn bg-white hover:bg-purple-50 text-purple-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">ë¶„ì‹</button>
                <button data-category="ì–‘ê¼¬ì¹˜" class="category-btn bg-white hover:bg-gray-50 text-gray-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">ì–‘ê¼¬ì¹˜</button>
                <button data-category="ë§ˆë¼íƒ•" class="category-btn bg-white hover:bg-pink-50 text-pink-600 font-semibold py-2 px-4 rounded-full shadow transition-colors duration-200 disabled:opacity-50">ë§ˆë¼íƒ•</button>
            </div>

            <!-- êµ¬ê¸€ ë§µ ì˜ì—­ -->
            <div id="map" class="w-full h-[50vh] md:h-[70vh] rounded-2xl shadow-xl border border-gray-200 bg-gray-100 flex items-center justify-center">
                <p class="text-gray-500">ì§€ë„ë¥¼ ë¡œë“œí•˜ë ¤ë©´ ìœ íš¨í•œ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
            </div>

        </div>

        <!-- ì¶”ì²œ ëª©ë¡ ì˜ì—­ -->
        <div class="w-full md:w-1/3 flex flex-col gap-4">
            <h2 class="text-2xl font-bold text-gray-900 text-center md:text-left">ì¶”ì²œ ë§›ì§‘ ëª©ë¡</h2>
            <div id="results-list" class="bg-white rounded-2xl shadow-xl p-4 border border-gray-200 h-[30vh] md:h-[70vh] overflow-y-auto">
                <p class="text-center text-gray-500">
                    ë¨¼ì € ìœ íš¨í•œ API í‚¤ë¥¼ ì…ë ¥í•˜ê³ <br>ì§€ë„ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”.
                </p>
            </div>
        </div>
    </div>
    <footer class="text-center text-gray-500 text-sm mt-8 mb-4">
        Â© 2024. ì´ ì›¹ì•±ì€ Google Maps APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    </footer>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let map = null;
        let placesService = null;
        let userLocation = null;
        let markers = [];
        let currentCategory = '';
        let isMapReady = false;
        let currentApiKey = '';

        // API í‚¤ ë¡œë“œ í•¨ìˆ˜
        function loadGoogleMapsAPI(apiKey) {
            return new Promise((resolve, reject) => {
                // ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ì œê±°
                const existingScript = document.querySelector('script[src*="maps.googleapis.com"]');
                if (existingScript) {
                    existingScript.remove();
                }

                // window.google ê°ì²´ ì •ë¦¬
                if (window.google) {
                    delete window.google;
                }

                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initMap`;
                script.async = true;
                script.defer = true;
                
                script.onload = () => {
                    console.log('Google Maps API ë¡œë“œ ì„±ê³µ');
                    resolve();
                };
                script.onerror = () => {
                    console.error('Google Maps API ë¡œë“œ ì‹¤íŒ¨');
                    reject(new Error('Google Maps API ë¡œë“œ ì‹¤íŒ¨'));
                };
                
                document.head.appendChild(script);
            });
        }

        // ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
        function initMap() {
            console.log('initMap í˜¸ì¶œë¨');
            
            // ìš©ì¸ìƒí˜„ì—­ ì¢Œí‘œ (ì‚¬ìš©ìê°€ ì–¸ê¸‰í•œ ìœ„ì¹˜)
            const yonginSanghyeon = { lat: 37.2592, lng: 127.1470 };
            
            try {
                // ì§€ë„ ìƒì„±
                map = new google.maps.Map(document.getElementById("map"), {
                    center: yonginSanghyeon, // ìš©ì¸ìƒí˜„ì—­ìœ¼ë¡œ ì¤‘ì‹¬ ì„¤ì •
                    zoom: 15,
                    disableDefaultUI: true,
                    zoomControl: true
                });

                // PlacesService ìƒì„±
                placesService = new google.maps.places.PlacesService(map);

                // ì‚¬ìš©ì ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° (ì •í™•ë„ ìš°ì„ )
                if (navigator.geolocation) {
                    const options = {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0 // ìºì‹œ ì‚¬ìš© ì•ˆí•¨
                    };

                    setMessage("í˜„ì¬ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...");

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            console.log('ì‹¤ì œ ì‚¬ìš©ì ìœ„ì¹˜:', userLocation);
                            console.log('ìœ„ì¹˜ ì •í™•ë„:', position.coords.accuracy, 'ë¯¸í„°');
                            
                            // ì§€ë„ ì¤‘ì‹¬ì„ ì‹¤ì œ ìœ„ì¹˜ë¡œ ì´ë™
                            map.setCenter(userLocation);
                            
                            // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€
                            new google.maps.Marker({
                                position: userLocation,
                                map: map,
                                title: "í˜„ì¬ ìœ„ì¹˜",
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 12,
                                    fillColor: '#4285F4',
                                    fillOpacity: 1,
                                    strokeColor: '#ffffff',
                                    strokeWeight: 3
                                }
                            });
                            
                            setMessage("âœ… í˜„ì¬ ìœ„ì¹˜ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”!");
                            showCategoryButtons();
                        },
                        (error) => {
                            console.warn("ìœ„ì¹˜ ì •ë³´ ì˜¤ë¥˜:", error);
                            
                            // ìœ„ì¹˜ ì •ë³´ ì‹¤íŒ¨ ì‹œ ìš©ì¸ìƒí˜„ì—­ ì‚¬ìš©
                            userLocation = yonginSanghyeon;
                            
                            // ê¸°ë³¸ ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€
                            new google.maps.Marker({
                                position: userLocation,
                                map: map,
                                title: "ê¸°ë³¸ ìœ„ì¹˜ (ìš©ì¸ìƒí˜„ì—­)",
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 12,
                                    fillColor: '#FF5722',
                                    fillOpacity: 1,
                                    strokeColor: '#ffffff',
                                    strokeWeight: 3
                                }
                            });
                            
                            setMessage("ìœ„ì¹˜ ì ‘ê·¼ì´ ì œí•œë˜ì–´ ìš©ì¸ìƒí˜„ì—­ ê¸°ì¤€ìœ¼ë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”!");
                            showCategoryButtons();
                        },
                        options
                    );
                } else {
                    userLocation = yonginSanghyeon;
                    setMessage("ìœ„ì¹˜ ì •ë³´ê°€ ì§€ì›ë˜ì§€ ì•Šì•„ ìš©ì¸ìƒí˜„ì—­ ê¸°ì¤€ìœ¼ë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤.");
                    showCategoryButtons();
                }

                isMapReady = true;
                hideApiKeySection();

            } catch (error) {
                console.error("ì§€ë„ ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                setMessage("ì§€ë„ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
        }

        // UI ì œì–´ í•¨ìˆ˜ë“¤
        function showCategoryButtons() {
            document.getElementById('category-buttons').style.display = 'grid';
            document.getElementById('results-list').innerHTML = `
                <p class="text-center text-gray-500">
                    ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ë©´<br>ê°€ê¹Œìš´ ë§›ì§‘ì´ í‘œì‹œë©ë‹ˆë‹¤.
                </p>
            `;
        }

        function hideApiKeySection() {
            const apiKeySection = document.querySelector('.bg-blue-50');
            if (apiKeySection) {
                apiKeySection.style.display = 'none';
            }
        }

        function setMessage(text) {
            const messageBox = document.getElementById("message-box");
            if (messageBox) {
                messageBox.textContent = text;
            }
        }

        function clearMarkers() {
            markers.forEach(marker => {
                if (marker && marker.setMap) {
                    marker.setMap(null);
                }
            });
            markers = [];
        }

        // ê²€ìƒ‰ í•¨ìˆ˜ (textSearch ì‚¬ìš© - ë” ì•ˆì •ì )
        function searchPlaces(category) {
            if (!isMapReady || !placesService || !userLocation) {
                setMessage("ì§€ë„ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            currentCategory = category;
            setMessage(`'${category}' ë§›ì§‘ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...`);
            
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(btn => btn.disabled = true);

            // textSearch ì‚¬ìš© (ë” ì•ˆì •ì ì´ê³  í•œêµ­ì–´ ì§€ì› ì¢‹ìŒ)
            const request = {
                query: `${category} ë§›ì§‘ restaurant`,
                location: userLocation,
                radius: 2000, // 2kmë¡œ í™•ì¥
                type: ['restaurant']
            };

            placesService.textSearch(request, (results, status) => {
                console.log('í…ìŠ¤íŠ¸ ê²€ìƒ‰ ê²°ê³¼:', status, results);
                
                if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                    displayResults(results);
                } else {
                    // textSearch ì‹¤íŒ¨ ì‹œ nearbySearch ì‹œë„
                    console.log('textSearch ì‹¤íŒ¨, nearbySearch ì‹œë„');
                    
                    const nearbyRequest = {
                        location: userLocation,
                        radius: 2000,
                        type: ['restaurant'],
                        keyword: category
                    };
                    
                    placesService.nearbySearch(nearbyRequest, (results, status) => {
                        console.log('Nearby ê²€ìƒ‰ ê²°ê³¼:', status, results);
                        
                        if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                            displayResults(results);
                        } else {
                            showNoResults(status);
                        }
                        
                        buttons.forEach(btn => btn.disabled = false);
                    });
                    return;
                }
                
                buttons.forEach(btn => btn.disabled = false);
            });
        }

        // ê²°ê³¼ í‘œì‹œ
        function displayResults(results) {
            const resultsList = document.getElementById("results-list");
            resultsList.innerHTML = '';
            clearMarkers();

            const validResults = results.filter(place => 
                place && 
                place.geometry && 
                place.geometry.location && 
                place.name
            ).slice(0, 5);

            if (validResults.length === 0) {
                showNoResults();
                return;
            }

            validResults.forEach((place, index) => {
                const location = place.geometry.location;
                const name = place.name;
                const address = place.formatted_address || place.vicinity || "ì£¼ì†Œ ì •ë³´ ì—†ìŒ";
                const rating = place.rating ? place.rating.toFixed(1) : null;

                // ëª©ë¡ ì•„ì´í…œ ìƒì„±
                const listItem = document.createElement("div");
                listItem.className = "flex items-center gap-4 p-3 hover:bg-gray-100 transition-colors duration-200 rounded-lg cursor-pointer";
                
                listItem.innerHTML = `
                    <div class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-500 text-white font-bold text-sm shadow">
                        ${index + 1}
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-lg text-gray-900">${name}</h3>
                        <p class="text-sm text-gray-500">${address}</p>
                        ${rating ? `<p class="text-sm text-yellow-600">â­ ${rating}</p>` : ''}
                    </div>
                `;

                listItem.addEventListener('click', () => {
                    map.panTo(location);
                    map.setZoom(17);
                });

                resultsList.appendChild(listItem);
                
                if (index < validResults.length - 1) {
                    const divider = document.createElement("div");
                    divider.className = "h-px bg-gray-200 my-2";
                    resultsList.appendChild(divider);
                }

                // ë§ˆì»¤ ì¶”ê°€
                const marker = new google.maps.Marker({
                    map: map,
                    position: location,
                    title: name
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div class="font-sans p-2">
                            <h4 class="font-bold text-md mb-1">${name}</h4>
                            <p class="text-sm text-gray-600">${address}</p>
                            ${rating ? `<p class="text-sm text-yellow-600">â­ ${rating}</p>` : ''}
                        </div>
                    `
                });

                marker.addListener("click", () => {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            });

            setMessage(`ì£¼ë³€ ${currentCategory} ë§›ì§‘ ${validResults.length}ê³³ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!`);
        }

        function showNoResults(status = null) {
            const resultsList = document.getElementById("results-list");
            let message = `ì£¼ë³€ì— ${currentCategory} ë§›ì§‘ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
            
            if (status === google.maps.places.PlacesServiceStatus.REQUEST_DENIED) {
                message = "API í‚¤ì— Places API ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. Google Cloud Consoleì—ì„œ Places APIë¥¼ í™œì„±í™”í•´ì£¼ì„¸ìš”.";
            } else if (status === google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT) {
                message = "API ì‚¬ìš©ëŸ‰ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ê²°ì œ ê³„ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
            }
            
            resultsList.innerHTML = `<p class="text-center text-gray-500">${message}</p>`;
            setMessage(message);
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('DOMContentLoaded', () => {
            // API í‚¤ ë¡œë“œ ë²„íŠ¼
            document.getElementById('load-map-btn').addEventListener('click', async () => {
                const apiKey = document.getElementById('api-key-input').value.trim();
                
                if (!apiKey) {
                    alert('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                currentApiKey = apiKey;
                setMessage('Google Maps APIë¥¼ ë¡œë“œí•˜ê³  ìˆìŠµë‹ˆë‹¤...');
                
                try {
                    window.initMap = initMap;
                    await loadGoogleMapsAPI(apiKey);
                } catch (error) {
                    console.error('API ë¡œë“œ ì˜¤ë¥˜:', error);
                    setMessage('API ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ì™€ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            });

            // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ë“¤
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    const category = button.dataset.category;
                    searchPlaces(category);
                });
            });

            // Enter í‚¤ ì§€ì›
            document.getElementById('api-key-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('load-map-btn').click();
                }
            });
        });
    </script>
</body>
</html>
