<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë‚´ ì£¼ë³€ ë§›ì§‘ ì°¾ê¸° Â· v4</title>
  <style>
    :root { --bg:#0b1020; --panel:#121832; --muted:#8ea0c8; --accent:#5aa9ff; --accent2:#7ce7ac; --danger:#ff7a7a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,sans-serif;background:var(--bg);color:#e8eeff}
    header{padding:10px 14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;border-bottom:1px solid rgba(255,255,255,.08);position:sticky;top:0;z-index:3;background:linear-gradient(180deg,rgba(11,16,32,.96),rgba(11,16,32,.86))}
    .title{font-weight:700;margin-right:auto;display:flex;gap:8px;align-items:center}
    .small{color:var(--muted);font-size:12px}
    .wrap{display:grid;grid-template-columns:360px 1fr;height:calc(100vh - 64px)}
    @media (max-width:980px){.wrap{grid-template-columns:1fr;grid-template-rows:48vh 52vh}}
    #map{width:100%;height:100%;background:#0e1328}
    .panel{background:var(--panel);border-left:1px solid rgba(255,255,255,.08);padding:10px;overflow:auto}
    @media (max-width:980px){.panel{border-left:none;border-top:1px solid rgba(255,255,255,.08)}}
    .buttons{display:grid;grid-auto-flow:column;grid-auto-columns:max-content;gap:6px;overflow-x:auto;padding-bottom:6px}
    .btn{border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.04);color:#eaf1ff;padding:8px 10px;border-radius:999px;font-size:14px;cursor:pointer;white-space:nowrap}
    .btn:hover{background:rgba(255,255,255,.08)}
    .btn.active{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#0b1020;font-weight:700}
    .status{color:var(--muted);font-size:13px}
    .loc{color:var(--muted);font-size:12px}
    .list{display:grid;gap:10px;padding:8px 2px}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;display:grid;gap:6px}
    .name{font-weight:700}
    .meta{color:var(--muted);font-size:13px;display:flex;gap:10px;flex-wrap:wrap}
    .rank{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:6px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);font-weight:700;margin-right:6px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:rgba(255,255,255,.06);padding:2px 6px;border-radius:6px;border:1px solid rgba(255,255,255,.12)}
    .danger{color:var(--danger)}
  </style>
</head>
<body>
  <header>
    <div class="title">ğŸœ ë‚´ ì£¼ë³€ ë§›ì§‘ ì°¾ê¸° <span id="activeLabel" class="small">ì¹´í…Œê³ ë¦¬ ì„ íƒ</span></div>
    <div class="buttons" id="buttons"></div>
    <div class="status" id="status">ì´ˆê¸°í™” ì¤‘...</div>
  </header>

  <div class="wrap">
    <aside class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px">
        <div class="loc" id="locText">í˜„ì¬ ìœ„ì¹˜: íŒŒì•… ì¤‘</div>
        <button id="recenterBtn" class="btn">í˜„ì¬ ìœ„ì¹˜ ì¬ì„¤ì •</button>
      </div>
      <div class="small">ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ê°€ê¹Œìš´ 5ê³³ì„ ê±°ë¦¬ìˆœìœ¼ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤. (Places API New ì‚¬ìš©)</div>
      <div class="list" id="list"></div>
      <div class="small" style="padding-top:6px">Tip: ìœ„ì¹˜ ê¶Œí•œì€ <span class="kbd">https</span> ë˜ëŠ” <span class="kbd">localhost</span> ì—ì„œë§Œ ì •ìƒ ë™ì‘.</div>
    </aside>
    <main id="map"></main>
  </div>

  <script>
    // ===== ì„¤ì • =====
    const API_KEY = 'AIzaSyASe5K_ijvZ6duDsIGWejVX1evTRJZ179Y'; // ë°˜ë“œì‹œ HTTP referrer ì œí•œ
    const MAP_ID = 'YOUR_VECTOR_MAP_ID'; // â–¶ Google Cloud Consoleì—ì„œ Maps > Map Management > New Map ID ìƒì„± í›„ êµì²´

    const CATEGORY_MAP = {
      'ì¤‘ì‹': { includedTypes: ['chinese_restaurant'] },
      'ì°œíƒ•': { includedTypes: ['restaurant'], keyword: 'ì°œ íƒ• ê°ìíƒ• í•´ë¬¼ì°œ ê°ˆë¹„ì°œ ê³°íƒ• soup stew' },
      'í•œì‹': { includedTypes: ['korean_restaurant'] },
      'í”¼ì': { includedTypes: ['pizza_restaurant'] },
      'ì¹˜í‚¨': { includedTypes: ['chicken_restaurant'] },
      'ë¶„ì‹': { includedTypes: ['restaurant'], keyword: 'ë¶„ì‹ ë–¡ë³¶ì´ ìˆœëŒ€ íŠ€ê¹€ tteokbokki snack bar' },
      'ì–‘ê¼¬ì¹˜': { includedTypes: ['restaurant'], keyword: 'ì–‘ê¼¬ì¹˜ ì–‘ê°ˆë¹„ lamb skewers yangkkochi chuan' },
      'ë§ˆë¼íƒ•': { includedTypes: ['restaurant'], keyword: 'ë§ˆë¼íƒ• ë§ˆë¼ìƒ¹ê¶ˆ malatang hot pot' }
    };
    const CATEGORY_ORDER = ['ì¤‘ì‹','ì°œíƒ•','í•œì‹','í”¼ì','ì¹˜í‚¨','ë¶„ì‹','ì–‘ê¼¬ì¹˜','ë§ˆë¼íƒ•'];

    let map, userLatLng, infoWindow, AdvancedMarkerElement, LegacyMarker;
    const resultMarkers = [];

    function setStatus(msg, isError=false){ const el=document.getElementById('status'); el.textContent=msg; el.className=isError?'status danger':'status'; }
    function setLocText(t){ document.getElementById('locText').textContent=`í˜„ì¬ ìœ„ì¹˜: ${t}`; }
    function metersToText(m){ if(!Number.isFinite(m)) return ''; return m<1000?`${Math.round(m)} m`:`${(m/1000).toFixed(2)} km`; }
    function clearResultMarkers(){ while(resultMarkers.length){ const m=resultMarkers.pop(); if(m?.remove) m.remove(); else if(m?.setMap) m.setMap(null); } }
    function haversine(a,b){ const R=6371000,toRad=x=>x*Math.PI/180; const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng); const s1=Math.sin(dLat/2)**2, s2=Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(s1+s2)); }

    function renderButtons(){
      const box=document.getElementById('buttons');
      CATEGORY_ORDER.forEach(cat=>{
        const b=document.createElement('button'); b.className='btn'; b.textContent=cat; b.dataset.cat=cat;
        b.addEventListener('click',()=>{ if(!userLatLng) return setStatus('ìœ„ì¹˜ í™•ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.', true); document.getElementById('activeLabel').textContent=`ì„ íƒ: ${cat}`; findNearby(cat); });
        box.appendChild(b);
      });
    }

    async function initMap(){
      setStatus('ì§€ë„ ë¡œë”© ì¤‘...');
      const { Map } = await google.maps.importLibrary('maps');
      const markerLib = await google.maps.importLibrary('marker');
      AdvancedMarkerElement = markerLib.AdvancedMarkerElement; // ìƒˆ ë§ˆì»¤
      LegacyMarker = google.maps.Marker; // í´ë°±
      infoWindow = new google.maps.InfoWindow();

      const defaultCenter = { lat: 37.5665, lng: 126.9780 };
      const mapOptions = {
        center: defaultCenter, zoom: 14, streetViewControl:false, mapTypeControl:false, fullscreenControl:true, backgroundColor:'#0e1328'
      };
      if (MAP_ID && !MAP_ID.includes('YOUR_VECTOR_MAP_ID')) mapOptions.mapId = MAP_ID; // ë²¡í„° ë§µ í™œì„±í™”
      map = new Map(document.getElementById('map'), mapOptions);

      if('geolocation' in navigator){
        navigator.geolocation.getCurrentPosition(pos=>{
          const { latitude, longitude } = pos.coords; userLatLng = { lat: latitude, lng: longitude };
          map.setCenter(userLatLng); map.setZoom(15);
          addSelfMarker(userLatLng);
          setStatus('ìœ„ì¹˜ í™•ì¸ë¨. ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
          setLocText(`${latitude.toFixed(5)}, ${longitude.toFixed(5)}`);
        }, err=>{ console.warn(err); setStatus('ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì–´ ê¸°ë³¸ ìœ„ì¹˜ë¡œ í‘œì‹œ ì¤‘ì…ë‹ˆë‹¤.', true); setLocText('ê¶Œí•œ ê±°ë¶€ë¨'); addSelfMarker(defaultCenter); }, { timeout: 10000, maximumAge: 60000 });
      } else { setStatus('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', true); setLocText('ë¯¸ì§€ì›'); addSelfMarker(defaultCenter); }

      document.getElementById('recenterBtn').addEventListener('click',()=>{ if(!userLatLng) return setStatus('ìœ„ì¹˜ ì •ë³´ ì—†ìŒ. ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•˜ì„¸ìš”.', true); map.panTo(userLatLng); map.setZoom(15); });
      renderButtons();
    }

    function addSelfMarker(position){
      // AdvancedMarkerElementëŠ” ë²¡í„° ë§µ(mapId í•„ìš”)ì—ì„œë§Œ ì™„ì „ ì§€ì›. ì—†ìœ¼ë©´ ë ˆê±°ì‹œ ë§ˆì»¤ ì‚¬ìš©
      if (AdvancedMarkerElement && map.getMapId && map.getMapId()) {
        const el=document.createElement('div'); el.style.cssText='width:14px;height:14px;border-radius:50%;background:#7ce7ac;border:2px solid #173a2a';
        const m = new AdvancedMarkerElement({ map, position, content: el, title:'ë‚´ ìœ„ì¹˜' });
        resultMarkers.push({ remove: ()=>m.map=null });
      } else {
        const m = new LegacyMarker({ map, position, title:'ë‚´ ìœ„ì¹˜' });
        resultMarkers.push({ setMap: (v)=>m.setMap(v) });
        console.warn('AdvancedMarkerElement í´ë°±: ìœ íš¨í•œ mapIdê°€ ì—†ê±°ë‚˜ ë¸Œë¼ìš°ì €ê°€ ë²¡í„° ë§µì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }
    }

    async function findNearby(category){
      clearResultMarkers(); document.getElementById('list').innerHTML=''; setStatus(`${category} ê²€ìƒ‰ ì¤‘...`);
      const cfg = CATEGORY_MAP[category] || { includedTypes:['restaurant'] };
      const body = {
        includedTypes: cfg.includedTypes,
        maxResultCount: 20,
        rankPreference: 'DISTANCE',
        languageCode: 'ko',
        locationRestriction: { circle: { center: { latitude: userLatLng.lat, longitude: userLatLng.lng }, radius: 5000 } }
      };
      if(cfg.keyword) body.textQuery = cfg.keyword;
      try{
        const resp = await fetch('https://places.googleapis.com/v1/places:searchNearby',{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'X-Goog-Api-Key': API_KEY,
            'X-Goog-FieldMask':'places.id,places.displayName,places.formattedAddress,places.location,places.rating,places.userRatingCount,places.currentOpeningHours.openNow'
          },
          body: JSON.stringify(body)
        });
        if(!resp.ok){
          const text = await resp.text();
          console.error('Places API response', resp.status, text);
          if (resp.status === 403) {
            setStatus('ê²€ìƒ‰ ì‹¤íŒ¨(403). API í‚¤ ê¶Œí•œ/ê²°ì œê°€ ë§‰í˜€ìˆìŠµë‹ˆë‹¤. ì•ˆë‚´ë¥¼ í™•ì¸í•˜ì„¸ìš”.', true);
          } else if (resp.status === 404) {
            setStatus('ê²€ìƒ‰ ì‹¤íŒ¨(404). ì—”ë“œí¬ì¸íŠ¸ ë˜ëŠ” ë¦¬ì†ŒìŠ¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”.', true);
          } else {
            setStatus(`ê²€ìƒ‰ ì‹¤íŒ¨(${resp.status}). ì½˜ì†” ë¡œê·¸ í™•ì¸.`, true);
          }
          return;
        }
        const data = await resp.json();
        const places = Array.isArray(data.places)? data.places: [];
        if(places.length===0){ setStatus('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', true); return; }
        const withDist = places.map(p=>{ const loc={ lat:p.location.latitude, lng:p.location.longitude }; return { place:p, loc, distance: haversine(userLatLng, loc) }; }).sort((a,b)=>a.distance-b.distance).slice(0,5);
        withDist.forEach((it,idx)=> addResultMarker(it, idx));
        renderList(withDist); setStatus(`${category} ê²°ê³¼ ${withDist.length}ê°œ`);
      }catch(e){ console.error(e); setStatus('ê²€ìƒ‰ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬/ì½˜ì†” ë¡œê·¸ í™•ì¸.', true); }
    }

    function addResultMarker(item, idx){
      const { place, loc, distance } = item;
      const name = place.displayName?.text || '';
      if (AdvancedMarkerElement && map.getMapId && map.getMapId()) {
        const el=document.createElement('div'); el.style.cssText='width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:#5aa9ff;border:2px solid #072847;color:#0b1020;font-weight:700'; el.textContent=String(idx+1);
        const m = new AdvancedMarkerElement({ map, position: loc, content: el, title: name });
        m.addListener('click',()=> openInfo(m, place, distance));
        resultMarkers.push({ remove: ()=>m.map=null });
      } else {
        const m = new LegacyMarker({ map, position: loc, label: String(idx+1), title: name });
        m.addListener('click',()=> openInfo(m, place, distance));
        resultMarkers.push({ setMap: (v)=>m.setMap(v) });
      }
      if(idx===0) map.panTo(loc);
    }

    function openInfo(marker, place, distance){
      if(!infoWindow) infoWindow = new google.maps.InfoWindow();
      const name = place.displayName?.text || 'ì´ë¦„ ì—†ìŒ';
      const addr = place.formattedAddress || '';
      const rating = place.rating ? `â­ï¸ ${Number(place.rating).toFixed(1)} (${place.userRatingCount||0})` : 'í‰ì  ì •ë³´ ì—†ìŒ';
      const openNow = place.currentOpeningHours?.openNow===true ? 'ì˜ì—… ì¤‘' : (place.currentOpeningHours?.openNow===false ? 'ì˜ì—… ì¢…ë£Œ' : '');
      const html = `<div style="min-width:220px;max-width:280px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,sans-serif"><div style="font-weight:700;font-size:14px;margin-bottom:4px">${name}</div><div style="font-size:12px;color:#55648d;margin-bottom:4px">${addr}</div><div style="font-size:12px;color:#55648d;display:flex;gap:8px;flex-wrap:wrap"><span>${rating}</span><span>ğŸ“ ${metersToText(distance)}</span>${openNow?`<span>${openNow}</span>`:''}</div></div>`;
      infoWindow.setContent(html); infoWindow.open({ map, anchor: marker });
    }

    function renderList(items){
      const list=document.getElementById('list');
      items.forEach((item, idx)=>{
        const { place, distance } = item; const card=document.createElement('div'); card.className='card';
        const name=document.createElement('div'); name.className='name'; name.innerHTML = `<span class="rank">${idx+1}</span> ${place.displayName?.text || ''}`;
        const meta=document.createElement('div'); meta.className='meta';
        const rating = place.rating ? `â­ï¸ ${Number(place.rating).toFixed(1)} (${place.userRatingCount||0})` : 'í‰ì  ì •ë³´ ì—†ìŒ';
        const addr = place.formattedAddress || '';
        meta.innerHTML = `<span>ğŸ“ ${metersToText(distance)}</span><span>${rating}</span><span>${addr}</span>`;
        card.appendChild(name); card.appendChild(meta);
        card.addEventListener('click',()=>{ /* ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ í•´ë‹¹ ë§ˆì»¤ë¡œ ì´ë™ */ });
        list.appendChild(card);
      });
    }

    window.initMap = initMap;
  </script>
  <!-- async + callback ë¡œë” -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyASe5K_ijvZ6duDsIGWejVX1evTRJZ179Y&loading=async&v=weekly&language=ko&region=KR&callback=initMap" async defer></script>
</body>
</html>
